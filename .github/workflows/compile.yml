name: ğŸ–‹ï¸ Compilateur LaTeX

on:
  repository_dispatch:
    types: [compile-latex]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  compile-latex:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸš€ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ“¦ VÃ©rifier LuaLaTeX
      run: |
        echo "ğŸ” VÃ©rification des compilateurs..."
        which pdflatex || echo "pdflatex: non installÃ©"
        which lualatex || echo "lualatex: non installÃ©"
        which xelatex  || echo "xelatex: non installÃ©"
        
        echo "ğŸ“Š Versions disponibles :"
        pdflatex --version || true
        lualatex --version || true
        xelatex --version  || true

    - name: ğŸ¯ Installer LuaLaTeX (si nÃ©cessaire)
      run: |
        if ! command -v lualatex &> /dev/null; then
            echo "ğŸ“¦ Installation de LuaLaTeX..."
            sudo apt-get update
            sudo apt-get install -y texlive-luatex texlive-fonts-recommended
        else
            echo "âœ… LuaLaTeX est dÃ©jÃ  installÃ©"
        fi

    - name: ğŸ“„ CrÃ©er le fichier LaTeX
      run: |
        echo "ğŸ“ DÃ©codage du contenu LaTeX..."
        echo "${{ github.event.client_payload.latex_content }}" | base64 -d > document.tex
        
        echo "ğŸ“‹ AperÃ§u du fichier :"
        head -n 5 document.tex
        echo "..."
        wc -l document.tex

    - name: âš™ï¸ Compiler avec LuaLaTeX
      run: |
        echo "ğŸš€ Compilation en cours..."
        lualatex --interaction=nonstopmode --halt-on-error document.tex
        
        if [ -f "document.pdf" ]; then
            echo "âœ… SUCCÃˆS : PDF gÃ©nÃ©rÃ© !"
            echo "ğŸ“Š Taille : $(du -h document.pdf | cut -f1)"
            echo "ğŸ“„ Pages : $(pdfinfo document.pdf 2>/dev/null | grep Pages | awk '{print $2}' || echo 'N/A')"
        else
            echo "âŒ Ã‰CHEC : Aucun PDF gÃ©nÃ©rÃ©"
            echo "ğŸ“œ Logs de compilation :"
            cat document.log || true
            exit 1
        fi

    - name: ğŸ“¤ Uploader le PDF (Version corrigÃ©e)
      uses: actions/upload-artifact@v4  # â† CHANGÃ‰ ICI : v3 â†’ v4
      with:
        name: document-pdf
        path: document.pdf
        retention-days: 1

    - name: ğŸ’¾ Sauvegarder pour la dÃ©mo
      run: |
        # Copier pour GitHub Pages
        cp document.pdf sample.pdf || true
        
        # Commit et push
        git config --local user.email "github-actions@github.com"
        git config --local user.name "GitHub Actions"
        git add sample.pdf || true
        git commit -m "ğŸ“„ Update sample PDF [skip ci]" || echo "Aucun changement"
        git push || echo "Push non nÃ©cessaire"